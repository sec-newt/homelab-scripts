#!/bin/bash
# Wallpaper picker using fuzzel and WallRizz
# Replaces the interactive WallRizz TUI with a simple list selection

# 1. Select wallpaper
cd ~/Pictures || exit 1
SELECTED=$(find . -maxdepth 1 -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) | sed 's|^\./||' | sort | fuzzel -d -p "Wallpaper: " -w 60)

if [ -z "$SELECTED" ]; then
    echo "No wallpaper selected"
    exit 0
fi

FULL_PATH="$HOME/Pictures/$SELECTED"

# 2. Force WallRizz to use this wallpaper
# We create a temp directory with just this image and use -r (random)
TMP_DIR=$(mktemp -d -t wallrizz-XXXXXX)
ln -sf "$FULL_PATH" "$TMP_DIR/image"

echo "Generating theme for $SELECTED..."
# Run WallRizz to generate config and cache
# -d: dir, -r: random (picks the only file), -n: no notification (we'll do our own or let system handle it)
WallRizz -d "$TMP_DIR" -r -n

# Cleanup temp dir
rm -rf "$TMP_DIR"

# 3. Apply changes (Logic taken from wallrizz-apply.sh)
echo "Reloading Hyprland..."
hyprctl reload

echo "Setting wallpaper with swww..."
# Parse the generated config to find the cached path (which has the colorscheme applied or is just the reference)
THEME_FILE=$(grep 'source = ' ~/.config/hypr/WallRizzTheme.conf | cut -d'/' -f8 | cut -d'-' -f1)
LATEST_WALLPAPER="$HOME/.cache/WallRizz/pic/${THEME_FILE}"

if [ -n "$LATEST_WALLPAPER" ] && [ -f "$LATEST_WALLPAPER" ]; then
    swww img "$LATEST_WALLPAPER" --transition-type grow --transition-pos 0.5,0.5 --transition-step 90
else
    echo "Fallback: using original image"
    swww img "$FULL_PATH" --transition-type grow --transition-pos 0.5,0.5 --transition-step 90
fi

# 4. Update Waybar (if script exists)
if [ -x ~/.config/hypr/scripts/apply-wallrizz-to-waybar.sh ]; then
    ~/.config/hypr/scripts/apply-wallrizz-to-waybar.sh
fi

# 5. Notify
hyprctl notify 3 4000 "rgb(00ff99)" "Wallpaper Applied: $SELECTED"
